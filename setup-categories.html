<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setup Categories - Single Source of Truth</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            margin: 0; 
            padding: 20px; 
            background: #f5f5f5; 
        }
        .container { max-width: 800px; margin: 0 auto; }
        .header { 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            margin-bottom: 20px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status-bar {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            border-left: 4px solid #2196f3;
        }
        .status-bar.success { background: #e8f5e8; border-left-color: #4caf50; }
        .status-bar.error { background: #ffebee; border-left-color: #f44336; }
        .btn { 
            background: #007bff; 
            color: white; 
            border: none; 
            padding: 12px 24px; 
            border-radius: 4px; 
            cursor: pointer; 
            margin: 10px 5px; 
            font-size: 16px;
        }
        .btn:hover { background: #0056b3; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #218838; }
        .categories-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .category-list {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
            border-left: 4px solid #dee2e6;
        }
        .category-list h4 { margin-top: 0; color: #495057; }
        .category-list ul { margin: 10px 0; padding-left: 20px; }
        .category-list li { margin: 5px 0; color: #6c757d; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîß Setup Categories - Single Source of Truth</h1>
            <p>This will create a categories table in your database that both the admin page and cards page will read from.</p>
        </div>

        <div id="statusBar" class="status-bar">
            <strong>Status:</strong> <span id="statusText">Ready to setup categories...</span>
        </div>

        <div class="categories-section">
            <h3>üìã Categories That Will Be Created</h3>
            
            <div class="category-list">
                <h4>Perk Categories:</h4>
                <ul>
                    <li>Lounge Access</li>
                    <li>TSA Pre/Global Entry</li>
                    <li>CLEAR</li>
                    <li>No Foreign Transaction Fees</li>
                    <li>Metal Card</li>
                </ul>
            </div>

            <div class="category-list">
                <h4>Protection Categories:</h4>
                <ul>
                    <li>Trip Delay & Cancellation</li>
                    <li>Lost or Delayed Baggage</li>
                    <li>Rental Car Insurance</li>
                    <li>Cell Phone Protection</li>
                    <li>Purchase Protection</li>
                </ul>
            </div>
        </div>

        <div class="header">
            <button class="btn btn-success" onclick="setupCategories()">üöÄ Setup Categories Table</button>
            <button class="btn" onclick="checkCategories()">üîç Check Current Categories</button>
            <button class="btn" onclick="createTableManually()">üîß Create Table Manually</button>
            <button class="btn" onclick="goToAdmin()">üìù Go to Admin Page</button>
        </div>

        <div id="results" style="margin-top: 20px;"></div>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        // Database configuration
        const SUPABASE_URL = 'https://zgfglwdjmpawuoxtbwcf.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpnZmdsd2RqbXBhd3VveHRid2NmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYzMjI2MzUsImV4cCI6MjA3MTg5ODYzNX0.JZHCnLPXaKI-Y5DRQVj-E-iBsyHXoxecxcnweM9LwyE';
        
        // Initialize Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        function updateStatus(message, type) {
            const statusBar = document.getElementById('statusBar');
            const statusText = document.getElementById('statusText');
            
            statusText.textContent = message;
            statusBar.className = `status-bar ${type}`;
            
            console.log(`Status: ${message}`);
        }

        async function setupCategories() {
            try {
                updateStatus('Setting up categories table...', 'info');
                
                // Define all categories
                const categories = [
                    // Perk Categories (exactly as shown in your image)
                    { type: 'perk', value: 'lounge-access', label: 'Lounge Access' },
                    { type: 'perk', value: 'tsa-precheck', label: 'TSA Pre/Global Entry' },
                    { type: 'perk', value: 'clear', label: 'CLEAR' },
                    { type: 'perk', value: 'no-foreign-fees', label: 'No Foreign Transaction Fees' },
                    { type: 'perk', value: 'metal-card', label: 'Metal Card' },
                    
                    // Protection Categories (exactly as you specified)
                    { type: 'protection', value: 'trip-delay-cancellation', label: 'Trip Delay & Cancellation' },
                    { type: 'protection', value: 'lost-delayed-baggage', label: 'Lost or Delayed Baggage' },
                    { type: 'protection', value: 'rental-car-insurance', label: 'Rental Car Insurance' },
                    { type: 'protection', value: 'cell-phone-protection', label: 'Cell Phone Protection' },
                    { type: 'protection', value: 'purchase-protection', label: 'Purchase Protection' }
                ];

                // Try to create the table by inserting a single record first
                updateStatus('Creating categories table...', 'info');
                
                const { data: testData, error: testError } = await supabase
                    .from('categories')
                    .insert([{
                        type: 'perk',
                        value: 'test',
                        label: 'Test Category'
                    }]);

                if (testError) {
                    throw new Error(`Failed to create table: ${testError.message}`);
                }

                // Delete the test record
                await supabase.from('categories').delete().eq('value', 'test');
                
                // Now insert all the real categories
                updateStatus('Inserting categories...', 'info');
                
                const { data: realData, error: realError } = await supabase
                    .from('categories')
                    .insert(categories);

                if (realError) {
                    throw new Error(`Failed to insert categories: ${realError.message}`);
                }

                updateStatus('‚úÖ Categories table created and populated successfully!', 'success');
                showResults('Categories setup complete!', realData);
                
            } catch (error) {
                console.error('Error setting up categories:', error);
                updateStatus('‚ùå Error setting up categories: ' + error.message, 'error');
                showResults('Error occurred', null, error.message);
            }
        }

        async function checkCategories() {
            try {
                updateStatus('Checking current categories...', 'info');
                
                const { data, error } = await supabase
                    .from('categories')
                    .select('*')
                    .order('type, label');

                if (error) {
                    if (error.message.includes('relation') && error.message.includes('does not exist')) {
                        updateStatus('‚ùå Categories table does not exist yet', 'error');
                        showResults('No categories table found', null, 'Run setup first');
                    } else {
                        throw error;
                    }
                } else {
                    updateStatus(`‚úÖ Found ${data.length} categories in database`, 'success');
                    showResults('Current categories:', data);
                }
                
            } catch (error) {
                console.error('Error checking categories:', error);
                updateStatus('‚ùå Error checking categories: ' + error.message, 'error');
                showResults('Error occurred', null, error.message);
            }
        }

        function showResults(title, data, error = null) {
            const resultsDiv = document.getElementById('results');
            
            if (error) {
                resultsDiv.innerHTML = `
                    <div class="categories-section">
                        <h3>‚ùå ${title}</h3>
                        <p style="color: #dc3545;">${error}</p>
                    </div>
                `;
                return;
            }

            if (!data || data.length === 0) {
                resultsDiv.innerHTML = `
                    <div class="categories-section">
                        <h3>üìã ${title}</h3>
                        <p>No data to display</p>
                    </div>
                `;
                return;
            }

            // Group by type
            const grouped = data.reduce((acc, item) => {
                if (!acc[item.type]) acc[item.type] = [];
                acc[item.type].push(item);
                return acc;
            }, {});

            let html = `<div class="categories-section"><h3>üìã ${title}</h3>`;
            
            Object.entries(grouped).forEach(([type, items]) => {
                const typeLabel = type.charAt(0).toUpperCase() + type.slice(1) + ' Categories';
                html += `
                    <div class="category-list">
                        <h4>${typeLabel} (${items.length}):</h4>
                        <ul>
                            ${items.map(item => `<li><strong>${item.value}:</strong> ${item.label}</li>`).join('')}
                        </ul>
                    </div>
                `;
            });
            
            html += '</div>';
            resultsDiv.innerHTML = html;
        }

        async function createTableManually() {
            try {
                updateStatus('Creating table manually...', 'info');
                
                // Use RPC to create the table
                const { data, error } = await supabase.rpc('create_categories_table');
                
                if (error) {
                    // If RPC doesn't exist, try direct SQL
                    updateStatus('RPC not available, trying direct approach...', 'info');
                    
                    // Try to create by inserting with proper structure
                    const { data: insertData, error: insertError } = await supabase
                        .from('categories')
                        .insert([{
                            id: 1,
                            type: 'perk',
                            value: 'lounge-access',
                            label: 'Lounge Access',
                            created_at: new Date().toISOString()
                        }]);

                    if (insertError) {
                        throw new Error(`Manual creation failed: ${insertError.message}`);
                    }

                    // Delete the test record
                    await supabase.from('categories').delete().eq('id', 1);
                    
                    updateStatus('‚úÖ Table created manually! Now run setup...', 'success');
                    showResults('Table created manually', null, 'Now click "Setup Categories Table" to populate it');
                    
                } else {
                    updateStatus('‚úÖ Table created via RPC!', 'success');
                    showResults('Table created via RPC', data);
                }
                
            } catch (error) {
                console.error('Error creating table manually:', error);
                updateStatus('‚ùå Manual creation failed: ' + error.message, 'error');
                showResults('Manual creation failed', null, error.message);
            }
        }

        function goToAdmin() {
            window.open('admin-database.html', '_blank');
        }
    </script>
</body>
</html> 